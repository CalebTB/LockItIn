# Surprise Party Template - UI Implementation Plan

**Issues:** #68, #69, #70
**Sprint:** 4, Week 7 (February 7-9, 2026)
**Estimated Time:** 15-18 hours total
**Focus:** Flutter UI, Screens, Widgets, State Management

---

## Overview

Implement the complete UI experience for Surprise Birthday Party template, including creation flow, coordinator dashboard, task management, and privacy enforcement in the UI layer.

**Database Schema:** âœ… Already implemented (migration 018, `events.template_data` JSONB)
**Data Models:** âœ… Already implemented (`SurprisePartyTemplateModel` with helper methods)
**What's Needed:** Flutter screens, widgets, providers, and role-based UI rendering

---

## Research Findings Summary

### Existing Infrastructure

**Data Model** (`lib/data/models/event_template_model.dart`):
```dart
class SurprisePartyTemplateModel extends EventTemplateModel {
  final String? guestOfHonorId;      // Hidden from this user
  final String? decoyTitle;          // Fake event shown to target
  final DateTime? revealAt;          // Auto-reveal time
  final List<SurprisePartyTask> tasks;
  final List<String> inOnItUserIds;  // Coordinators

  // Helper methods already exist:
  // - addTask(), toggleTask(), removeTask()
  // - isUserInOnIt(userId)
  // - get incompleteTasks, get completionPercentage
}
```

**Event Creation Screen** (`lib/presentation/screens/event_creation_screen.dart`):
- Template chips already exist (line 733: "ğŸ Surprise")
- `_applyTemplate()` method pre-fills fields (lines 177-235)
- Sets `visibility = EventVisibility.busyOnly` automatically
- Creates `SurprisePartyTemplateModel()` instance

**Privacy System:**
- Shadow Calendar dual-table architecture already handles event visibility
- RLS policies enforce privacy at database level
- Target user physically cannot see private events

---

## UI Components to Build

### 1. Surprise Party Configuration Sheet (Modal Bottom Sheet)

**Location:** `lib/presentation/widgets/templates/surprise_party_config_sheet.dart`

**Purpose:** Configure surprise party details after tapping "ğŸ Surprise" template chip

**UI Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configure Surprise Party         [X]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  WHO'S THE SURPRISE FOR?                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Search group members...        ğŸ” â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  [Avatar] Sarah Johnson                  â”‚
â”‚  [Avatar] Mike Chen                      â”‚
â”‚  [Avatar] Emma Davis                     â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  DECOY EVENT (WHAT THEY'LL SEE)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Team Lunch                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  âš ï¸ Sarah will see "Team Lunch" on      â”‚
â”‚  their calendar instead of the real     â”‚
â”‚  event title.                           â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  AUTO-REVEAL DATE (OPTIONAL)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Feb 15, 2026 at 6:00 PM      ğŸ“…   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  â„¹ï¸ Event will automatically reveal     â”‚
â”‚  to Sarah at this time.                 â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  WHO KNOWS ABOUT THE SURPRISE?          â”‚
â”‚  [âœ“] All group members except Sarah     â”‚
â”‚  [ ] Select specific coordinators       â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Continue to Tasks      â†’    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Widgets:**
- `GroupMemberSearchField` - Search/filter group members
- `MemberSelectionList` - Scrollable list with avatars
- `DecoyEventInput` - Text field with warning callout
- `DateTimePickerField` - Reveal time selector
- `CoordinatorSelectionToggle` - All vs. specific coordinators

**State Management:**
- Local `StatefulWidget` state for form inputs
- Validates before returning to parent screen
- Returns `SurprisePartyTemplateModel` via `Navigator.pop()`

**Implementation Details:**
```dart
class SurprisePartyConfigSheet extends StatefulWidget {
  final String groupId;
  final SurprisePartyTemplateModel? existingTemplate; // For edit mode

  @override
  State<SurprisePartyConfigSheet> createState() => _SurprisePartyConfigSheetState();
}

class _SurprisePartyConfigSheetState extends State<SurprisePartyConfigSheet> {
  String? _selectedTargetUserId;
  final _decoyTitleController = TextEditingController();
  DateTime? _revealAt;
  CoordinatorSelection _coordinatorSelection = CoordinatorSelection.allExceptTarget;
  List<String> _selectedCoordinatorIds = [];

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final appColors = context.appColors;

    return DraggableScrollableSheet(
      initialChildSize: 0.9,
      maxChildSize: 0.95,
      minChildSize: 0.5,
      builder: (context, scrollController) {
        return Container(
          decoration: BoxDecoration(
            color: colorScheme.surface,
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              _buildHeader(),
              Expanded(
                child: ListView(
                  controller: scrollController,
                  padding: EdgeInsets.all(AppSpacing.lg),
                  children: [
                    _buildTargetUserSection(),
                    SizedBox(height: AppSpacing.xl),
                    _buildDecoyEventSection(),
                    SizedBox(height: AppSpacing.xl),
                    _buildRevealTimeSection(),
                    SizedBox(height: AppSpacing.xl),
                    _buildCoordinatorSection(),
                  ],
                ),
              ),
              _buildContinueButton(),
            ],
          ),
        );
      },
    );
  }

  void _handleContinue() {
    if (_selectedTargetUserId == null) {
      _showError('Please select who the surprise is for');
      return;
    }

    if (_decoyTitleController.text.isEmpty) {
      _showError('Please enter a decoy event title');
      return;
    }

    // Create template model
    final template = SurprisePartyTemplateModel(
      type: 'surprise_party',
      name: 'Surprise Birthday Party',
      emoji: 'ğŸ',
      guestOfHonorId: _selectedTargetUserId,
      decoyTitle: _decoyTitleController.text,
      revealAt: _revealAt,
      tasks: [], // Empty initially, added later
      inOnItUserIds: _getCoordinatorIds(),
    );

    Navigator.pop(context, template);
  }
}
```

---

### 2. Task Assignment Interface

**Location:** `lib/presentation/widgets/templates/surprise_party_task_list.dart`

**Purpose:** Manage party planning tasks (venue, cake, invitations, decorations)

**UI Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Party Planning Tasks            + Add   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  INCOMPLETE (3)                          â”‚
â”‚                                          â”‚
â”‚  â—‹  Book venue                           â”‚
â”‚      Not assigned                        â”‚
â”‚                                          â”‚
â”‚  â—‹  Order birthday cake                  â”‚
â”‚      ğŸ‘¤ Mike Chen                        â”‚
â”‚                                          â”‚
â”‚  â—‹  Send invitations                     â”‚
â”‚      ğŸ‘¤ Emma Davis                       â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  COMPLETED (2)                           â”‚
â”‚                                          â”‚
â”‚  âœ“  Buy decorations                      â”‚
â”‚      ğŸ‘¤ You                              â”‚
â”‚                                          â”‚
â”‚  âœ“  Plan surprise reveal                 â”‚
â”‚      ğŸ‘¤ Mike Chen                        â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Interactions:**
- Tap task â†’ Toggle complete/incomplete
- Long press â†’ Show menu (Edit, Reassign, Delete)
- Tap "Not assigned" â†’ Show assignee picker
- Drag to reorder (optional enhancement)

**Implementation:**
```dart
class SurprisePartyTaskList extends ConsumerWidget {
  final String eventId;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final event = ref.watch(eventDetailProvider(eventId));
    final template = event.surprisePartyTemplate;

    if (template == null) return SizedBox.shrink();

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildTaskHeader(context, ref),

        // Incomplete tasks
        if (template.incompleteTasks.isNotEmpty) ...[
          _buildSectionHeader('INCOMPLETE', template.incompleteTasks.length),
          ...template.incompleteTasks.map((task) =>
            _buildTaskItem(context, ref, task, isComplete: false)
          ),
        ],

        SizedBox(height: AppSpacing.md),

        // Completed tasks (collapsible)
        if (template.completedTasks.isNotEmpty) ...[
          _buildSectionHeader('COMPLETED', template.completedTasks.length),
          ...template.completedTasks.map((task) =>
            _buildTaskItem(context, ref, task, isComplete: true)
          ),
        ],
      ],
    );
  }

  Widget _buildTaskItem(BuildContext context, WidgetRef ref, SurprisePartyTask task, {required bool isComplete}) {
    final colorScheme = Theme.of(context).colorScheme;
    final appColors = context.appColors;

    return InkWell(
      onTap: () => _toggleTask(ref, task),
      onLongPress: () => _showTaskMenu(context, ref, task),
      child: Container(
        padding: EdgeInsets.all(AppSpacing.md),
        margin: EdgeInsets.only(bottom: AppSpacing.sm),
        decoration: BoxDecoration(
          color: appColors.cardBackground,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: appColors.cardBorder),
        ),
        child: Row(
          children: [
            Icon(
              isComplete ? Icons.check_circle : Icons.radio_button_unchecked,
              color: isComplete ? appColors.success : appColors.textMuted,
            ),
            SizedBox(width: AppSpacing.md),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    task.title,
                    style: TextStyle(
                      decoration: isComplete ? TextDecoration.lineThrough : null,
                      color: isComplete ? appColors.textMuted : colorScheme.onSurface,
                    ),
                  ),
                  if (task.assignedTo != null)
                    Padding(
                      padding: EdgeInsets.only(top: 4),
                      child: Row(
                        children: [
                          Icon(Icons.person, size: 14, color: appColors.textSecondary),
                          SizedBox(width: 4),
                          Text(
                            _getUserName(ref, task.assignedTo!),
                            style: TextStyle(fontSize: 12, color: appColors.textSecondary),
                          ),
                        ],
                      ),
                    )
                  else
                    Padding(
                      padding: EdgeInsets.only(top: 4),
                      child: Text(
                        'Not assigned',
                        style: TextStyle(fontSize: 12, color: appColors.textMuted, fontStyle: FontStyle.italic),
                      ),
                    ),
                ],
              ),
            ),
            Icon(Icons.more_vert, color: appColors.textMuted),
          ],
        ),
      ),
    );
  }

  void _toggleTask(WidgetRef ref, SurprisePartyTask task) {
    final eventProvider = ref.read(eventDetailProvider(eventId).notifier);
    eventProvider.toggleSurprisePartyTask(task.id);
  }
}
```

---

### 3. Coordinator Dashboard

**Location:** `lib/presentation/screens/surprise_party_dashboard.dart`

**Purpose:** Central hub for coordinators to see progress, tasks, and party details

**UI Structure:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â†  Sarah's Surprise Party               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  âš ï¸ SECRET EVENT                         â”‚
â”‚  Don't discuss around Sarah!             â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  ğŸ“Š PLANNING PROGRESS                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  60%          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  3 of 5 tasks completed                  â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  ğŸ“… REAL EVENT DETAILS                   â”‚
â”‚  February 15, 2026 at 7:00 PM            â”‚
â”‚  Mike's Place                            â”‚
â”‚  [Edit Event Details]                    â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  ğŸ‘ï¸ WHAT SARAH SEES                      â”‚
â”‚  "Team Lunch"                            â”‚
â”‚  February 15, 2026 at 12:00 PM           â”‚
â”‚  The Office                              â”‚
â”‚  [Edit Decoy Event]                      â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  ğŸ“‹ PARTY PLANNING TASKS                 â”‚
â”‚  [Task list from previous section]       â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                          â”‚
â”‚  ğŸ‘¥ COORDINATORS (3)                     â”‚
â”‚  [Avatar] You (Organizer)                â”‚
â”‚  [Avatar] Mike Chen                      â”‚
â”‚  [Avatar] Emma Davis                     â”‚
â”‚  [Add Coordinator]                       â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features:**
1. **Warning Banner** - Prominent reminder not to spoil surprise
2. **Progress Ring** - Visual completion percentage
3. **Dual Event Display** - Real vs. decoy side-by-side
4. **Task Management** - Embedded task list
5. **Coordinator Management** - Add/remove people in on the secret

**Implementation:**
```dart
class SurprisePartyDashboard extends ConsumerWidget {
  final String eventId;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final eventAsync = ref.watch(eventDetailProvider(eventId));

    return eventAsync.when(
      data: (event) {
        final template = event.surprisePartyTemplate!;

        return Scaffold(
          appBar: AppBar(
            title: Text('${_getTargetName(ref, template.guestOfHonorId!)}'s Surprise Party'),
          ),
          body: ListView(
            padding: EdgeInsets.all(AppSpacing.lg),
            children: [
              _buildWarningBanner(context),
              SizedBox(height: AppSpacing.xl),
              _buildProgressCard(context, template),
              SizedBox(height: AppSpacing.xl),
              _buildRealEventCard(context, event),
              SizedBox(height: AppSpacing.xl),
              _buildDecoyEventCard(context, ref, template),
              SizedBox(height: AppSpacing.xl),
              SurprisePartyTaskList(eventId: eventId),
              SizedBox(height: AppSpacing.xl),
              _buildCoordinatorsList(context, ref, template),
            ],
          ),
        );
      },
      loading: () => Center(child: CircularProgressIndicator()),
      error: (error, stack) => ErrorView(error: error),
    );
  }

  Widget _buildWarningBanner(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;

    return Container(
      padding: EdgeInsets.all(AppSpacing.md),
      decoration: BoxDecoration(
        color: Colors.orange.shade100,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.orange.shade300),
      ),
      child: Row(
        children: [
          Icon(Icons.warning, color: Colors.orange.shade900),
          SizedBox(width: AppSpacing.md),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'âš ï¸ SECRET EVENT',
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: Colors.orange.shade900,
                  ),
                ),
                Text(
                  'Don\'t discuss this around ${_targetName}!',
                  style: TextStyle(color: Colors.orange.shade900),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildProgressCard(BuildContext context, SurprisePartyTemplateModel template) {
    final colorScheme = Theme.of(context).colorScheme;
    final appColors = context.appColors;
    final percentage = template.completionPercentage;

    return Container(
      padding: EdgeInsets.all(AppSpacing.lg),
      decoration: BoxDecoration(
        color: appColors.cardBackground,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: appColors.cardBorder),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'ğŸ“Š PLANNING PROGRESS',
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w600,
              color: appColors.textSecondary,
              letterSpacing: 0.5,
            ),
          ),
          SizedBox(height: AppSpacing.md),

          // Progress bar
          ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: LinearProgressIndicator(
              value: percentage / 100,
              minHeight: 24,
              backgroundColor: appColors.divider,
              valueColor: AlwaysStoppedAnimation(
                percentage == 100 ? appColors.success : colorScheme.primary,
              ),
            ),
          ),

          SizedBox(height: AppSpacing.sm),
          Text(
            '${template.completedTasks.length} of ${template.tasks.length} tasks completed',
            style: TextStyle(color: appColors.textSecondary),
          ),
        ],
      ),
    );
  }
}
```

---

### 4. Privacy Enforcement in UI

**Key Privacy Rules:**

1. **Target Never Sees Real Event**
   - Filter events where `surprisePartyTemplate.guestOfHonorId == currentUserId`
   - Show decoy event instead (different title, time can match or differ)
   - Decoy syncs to target's calendar as "real" event

2. **Coordinators See Warning Badges**
   - Show "ğŸ¤« Secret" badge on event cards
   - Display warning banner in event details
   - Add visual indicators in calendar grid

3. **Non-Coordinators See Nothing**
   - Participants not in `inOnItUserIds` see neither real nor decoy
   - OR they see proposal if it's in voting stage (depends on group visibility)

**Implementation in Event Card Widget:**

```dart
// lib/presentation/widgets/event_card.dart

Widget build(BuildContext context, WidgetRef ref) {
  final currentUserId = ref.watch(currentUserIdProvider);

  // Privacy check: Is this user the surprise target?
  if (event.isSurpriseParty) {
    final template = event.surprisePartyTemplate!;

    if (template.guestOfHonorId == currentUserId) {
      // Show decoy event instead
      return _buildDecoyEventCard(context, template);
    }

    // Check if user is a coordinator
    if (template.isUserInOnIt(currentUserId)) {
      // Show real event with warning badge
      return _buildRealEventCardWithBadge(context, event);
    }

    // User not involved, hide event
    return SizedBox.shrink();
  }

  // Normal event rendering
  return _buildNormalEventCard(context, event);
}

Widget _buildDecoyEventCard(BuildContext context, SurprisePartyTemplateModel template) {
  // Shows fake title and details
  return Container(
    decoration: BoxDecoration(
      color: appColors.cardBackground,
      borderRadius: BorderRadius.circular(12),
    ),
    child: ListTile(
      leading: Text('ğŸ“…', style: TextStyle(fontSize: 24)),
      title: Text(template.decoyTitle ?? 'Event'),
      subtitle: Text(_formatEventTime()),
    ),
  );
}

Widget _buildRealEventCardWithBadge(BuildContext context, EventModel event) {
  return Container(
    decoration: BoxDecoration(
      color: appColors.cardBackground,
      borderRadius: BorderRadius.circular(12),
      border: Border.all(color: Colors.orange.shade300, width: 2),
    ),
    child: Stack(
      children: [
        // Normal event content
        ListTile(
          leading: Text(event.emoji ?? 'ğŸ', style: TextStyle(fontSize: 24)),
          title: Text(event.title),
          subtitle: Text(_formatEventTime()),
        ),

        // Secret badge
        Positioned(
          top: 8,
          right: 8,
          child: Container(
            padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: Colors.orange,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(Icons.lock, size: 12, color: Colors.white),
                SizedBox(width: 4),
                Text(
                  'SECRET',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    ),
  );
}
```

---

### 5. State Management (Riverpod Providers)

**Event Detail Provider with Template Support:**

```dart
// lib/presentation/providers/event_detail_provider.dart

@riverpod
class EventDetail extends _$EventDetail {
  @override
  Future<EventModel> build(String eventId) async {
    final eventService = ref.watch(eventServiceProvider);
    return eventService.getEventById(eventId);
  }

  // Task management methods
  Future<void> toggleSurprisePartyTask(String taskId) async {
    final currentEvent = await future;
    if (currentEvent.surprisePartyTemplate == null) return;

    final updatedTemplate = currentEvent.surprisePartyTemplate!.toggleTask(taskId);

    // Optimistic update
    state = AsyncValue.data(
      currentEvent.copyWith(
        templateData: updatedTemplate,
      ),
    );

    // Persist to backend
    try {
      final eventService = ref.read(eventServiceProvider);
      await eventService.updateEvent(
        eventId,
        templateData: updatedTemplate.toJson(),
      );
    } catch (e) {
      // Rollback on error
      state = AsyncValue.data(currentEvent);
      rethrow;
    }
  }

  Future<void> addSurprisePartyTask({
    required String title,
    String? assignedTo,
  }) async {
    final currentEvent = await future;
    if (currentEvent.surprisePartyTemplate == null) return;

    final updatedTemplate = currentEvent.surprisePartyTemplate!.addTask(
      title: title,
      assignedTo: assignedTo,
    );

    state = AsyncValue.data(
      currentEvent.copyWith(templateData: updatedTemplate),
    );

    final eventService = ref.read(eventServiceProvider);
    await eventService.updateEvent(
      eventId,
      templateData: updatedTemplate.toJson(),
    );
  }

  Future<void> updateDecoyEvent({
    String? decoyTitle,
    DateTime? decoyTime,
  }) async {
    final currentEvent = await future;
    if (currentEvent.surprisePartyTemplate == null) return;

    final updatedTemplate = currentEvent.surprisePartyTemplate!.copyWith(
      decoyTitle: decoyTitle,
      // Note: decoy time stored separately if needed
    );

    state = AsyncValue.data(
      currentEvent.copyWith(templateData: updatedTemplate),
    );

    final eventService = ref.read(eventServiceProvider);
    await eventService.updateEvent(
      eventId,
      templateData: updatedTemplate.toJson(),
    );
  }
}

// Helper provider for current user's role
@riverpod
UserRoleInEvent userRoleInEvent(Ref ref, String eventId) {
  final eventAsync = ref.watch(eventDetailProvider(eventId));
  final currentUserId = ref.watch(currentUserIdProvider);

  return eventAsync.when(
    data: (event) {
      if (!event.isSurpriseParty) return UserRoleInEvent.none;

      final template = event.surprisePartyTemplate!;

      if (event.createdBy == currentUserId) return UserRoleInEvent.organizer;
      if (template.guestOfHonorId == currentUserId) return UserRoleInEvent.target;
      if (template.isUserInOnIt(currentUserId)) return UserRoleInEvent.coordinator;

      return UserRoleInEvent.none;
    },
    loading: () => UserRoleInEvent.none,
    error: (_, __) => UserRoleInEvent.none,
  );
}

enum UserRoleInEvent {
  organizer,
  coordinator,
  target,
  none,
}
```

---

## Integration Points

### 1. Event Creation Flow

**Modified:** `lib/presentation/screens/event_creation_screen.dart`

```dart
// When user taps "ğŸ Surprise" template chip
void _applyTemplate(EventTemplate template) {
  if (template == EventTemplate.surpriseParty) {
    // Show configuration sheet
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => SurprisePartyConfigSheet(
        groupId: widget.groupId!,
      ),
    ).then((result) {
      if (result != null && result is SurprisePartyTemplateModel) {
        setState(() {
          _selectedTemplate = template;
          _templateData = result;
          _titleController.text = 'Surprise Birthday Party for ${_getTargetName(result.guestOfHonorId)}';
          _emoji = 'ğŸ';
          _visibility = EventVisibility.busyOnly; // Auto-set privacy
        });
      }
    });
  }
}
```

### 2. Event Detail Screen

**Modified:** `lib/presentation/screens/event_detail_screen.dart`

```dart
Widget build(BuildContext context, WidgetRef ref) {
  final eventAsync = ref.watch(eventDetailProvider(eventId));
  final userRole = ref.watch(userRoleInEventProvider(eventId));

  return eventAsync.when(
    data: (event) {
      // Role-based rendering
      if (event.isSurpriseParty) {
        return switch (userRole) {
          UserRoleInEvent.organizer || UserRoleInEvent.coordinator =>
            SurprisePartyDashboard(eventId: eventId),
          UserRoleInEvent.target =>
            _buildDecoyEventView(event),
          UserRoleInEvent.none =>
            Center(child: Text('Event not found')),
        };
      }

      // Normal event detail view
      return _buildNormalEventDetail(event);
    },
    loading: () => Center(child: CircularProgressIndicator()),
    error: (error, stack) => ErrorView(error: error),
  );
}

Widget _buildDecoyEventView(EventModel event) {
  final template = event.surprisePartyTemplate!;

  return Scaffold(
    appBar: AppBar(title: Text(template.decoyTitle ?? 'Event')),
    body: Padding(
      padding: EdgeInsets.all(AppSpacing.lg),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Show decoy details
          Text(template.decoyTitle ?? 'Event', style: TextStyle(fontSize: 24)),
          SizedBox(height: AppSpacing.md),
          Text('When: ${_formatEventTime(event)}'),
          Text('Where: ${event.location ?? 'TBD'}'),

          // No tasks, no participants visible
          SizedBox(height: AppSpacing.xl),
          Text(
            'This is a group event.',
            style: TextStyle(color: appColors.textSecondary),
          ),
        ],
      ),
    ),
  );
}
```

### 3. Calendar Grid

**Modified:** `lib/presentation/screens/calendar_screen.dart`

```dart
Widget _buildEventDot(EventModel event) {
  final currentUserId = ref.watch(currentUserIdProvider);

  // Privacy filtering
  if (event.isSurpriseParty) {
    final template = event.surprisePartyTemplate!;

    if (template.guestOfHonorId == currentUserId) {
      // Show decoy indicator (different color/style)
      return Container(
        width: 6,
        height: 6,
        decoration: BoxDecoration(
          color: AppColors.categoryOther, // Generic color for decoy
          shape: BoxShape.circle,
        ),
      );
    }

    if (template.isUserInOnIt(currentUserId)) {
      // Show secret event indicator (orange border)
      return Container(
        width: 6,
        height: 6,
        decoration: BoxDecoration(
          color: colorScheme.primary,
          shape: BoxShape.circle,
          border: Border.all(color: Colors.orange, width: 1),
        ),
      );
    }

    // User not involved, hide dot
    return SizedBox.shrink();
  }

  // Normal event dot
  return Container(
    width: 6,
    height: 6,
    decoration: BoxDecoration(
      color: _getEventColor(event.category),
      shape: BoxShape.circle,
    ),
  );
}
```

---

## Acceptance Criteria

### Issue #68: Database (Already Complete âœ…)
- [x] `events.template_data` JSONB column exists
- [x] `SurprisePartyTemplateModel` with helper methods
- [x] RLS policies enforce privacy at DB level

### Issue #69: UI Implementation (This Plan)

**Template Configuration:**
- [ ] `SurprisePartyConfigSheet` modal bottom sheet
- [ ] Target user selection from group members
- [ ] Decoy event title input with warning
- [ ] Optional reveal time picker
- [ ] Coordinator selection (all vs. specific)
- [ ] Validation before continuing

**Task Management:**
- [ ] `SurprisePartyTaskList` widget displays tasks
- [ ] Tap to toggle task completion
- [ ] Long press to show task menu (edit, delete, reassign)
- [ ] "Add Task" button with inline form
- [ ] Visual distinction between complete/incomplete
- [ ] Assignee display with avatar and name

**Coordinator Dashboard:**
- [ ] `SurprisePartyDashboard` full screen
- [ ] Warning banner at top (orange, prominent)
- [ ] Progress card with completion percentage
- [ ] Real event details card
- [ ] Decoy event details card (with edit button)
- [ ] Embedded task list
- [ ] Coordinators list with add/remove

**State Management:**
- [ ] `EventDetailProvider` supports template operations
- [ ] `toggleSurprisePartyTask()` method
- [ ] `addSurprisePartyTask()` method
- [ ] `updateDecoyEvent()` method
- [ ] `userRoleInEventProvider` helper
- [ ] Optimistic updates with rollback on error

### Issue #70: Privacy Enforcement (UI Layer)

**Event Card Rendering:**
- [ ] Target sees decoy event card (fake title)
- [ ] Coordinators see real event with "SECRET" badge
- [ ] Non-coordinators see nothing (filtered out)
- [ ] Orange border on secret event cards

**Event Detail Screen:**
- [ ] Target sees only decoy details (no tasks, no real title)
- [ ] Coordinators see full dashboard
- [ ] Non-coordinators get "Event not found"
- [ ] Role-based rendering with `userRoleInEventProvider`

**Calendar Grid:**
- [ ] Target sees decoy event dots (generic color)
- [ ] Coordinators see secret event dots (orange border)
- [ ] Non-coordinators see no dots
- [ ] Day detail list respects same privacy rules

**Navigation Safety:**
- [ ] Deep links to surprise events check user role
- [ ] Sharing event redirects target to decoy view
- [ ] No accidental exposure via notifications (handled in backend)

---

## Testing Checklist

### Manual Testing Scenarios

**Scenario 1: Create Surprise Party**
1. Go to event creation screen
2. Tap "ğŸ Surprise" template chip
3. Config sheet opens
4. Select target user (Sarah)
5. Enter decoy title ("Team Lunch")
6. Set reveal time (optional)
7. Select coordinators (default: all except Sarah)
8. Tap "Continue to Tasks"
9. Verify template applied:
   - Title: "Surprise Birthday Party for Sarah"
   - Emoji: ğŸ
   - Visibility: Busy-Only (auto-set)
10. Add 3 tasks
11. Save event
12. Verify event saved with template data

**Scenario 2: Coordinator Views Event**
1. Log in as coordinator (not target)
2. Navigate to calendar
3. Find surprise event
4. Verify card shows "SECRET" badge and orange border
5. Tap event â†’ Dashboard opens
6. Verify warning banner visible
7. Verify progress bar shows correct percentage
8. Verify real event details shown
9. Verify decoy event details shown
10. Verify task list functional
11. Toggle task completion â†’ Verify saves
12. Add new task â†’ Verify saves
13. Edit decoy title â†’ Verify saves

**Scenario 3: Target Views Event**
1. Log in as target user (Sarah)
2. Navigate to calendar
3. Find event date
4. Verify sees "Team Lunch" (decoy)
5. Verify NO orange border, NO secret badge
6. Tap event â†’ Decoy detail screen opens
7. Verify ONLY sees decoy title
8. Verify CANNOT see tasks
9. Verify CANNOT see real event details
10. Verify CANNOT see coordinator list

**Scenario 4: Non-Coordinator Views Event**
1. Log in as group member NOT in coordinators list
2. Navigate to calendar
3. Verify event NOT visible (no dot on calendar)
4. Try to navigate via deep link
5. Verify gets "Event not found" error

**Scenario 5: Auto-Reveal**
1. Create surprise party with reveal time = now + 1 minute
2. Wait 1 minute
3. Target user refreshes app
4. Verify now sees REAL event (not decoy)
5. Verify can see tasks
6. Verify warning banner changes to "Surprise revealed!"

---

## Files to Create/Modify

### New Files
- `lib/presentation/widgets/templates/surprise_party_config_sheet.dart` (~350 lines)
- `lib/presentation/widgets/templates/surprise_party_task_list.dart` (~200 lines)
- `lib/presentation/screens/surprise_party_dashboard.dart` (~400 lines)
- `lib/presentation/widgets/templates/task_item_card.dart` (~100 lines)
- `lib/presentation/widgets/templates/add_task_sheet.dart` (~150 lines)

### Modified Files
- `lib/presentation/screens/event_creation_screen.dart` (add modal sheet trigger)
- `lib/presentation/screens/event_detail_screen.dart` (add role-based routing)
- `lib/presentation/widgets/event_card.dart` (add privacy rendering)
- `lib/presentation/providers/event_detail_provider.dart` (add template methods)
- `lib/presentation/screens/calendar_screen.dart` (add dot privacy filtering)

**Total New Code:** ~1,200 lines
**Total Modified Code:** ~200 lines

---

## Dependencies

**Required:**
- âœ… `SurprisePartyTemplateModel` (already exists)
- âœ… `EventModel.surprisePartyTemplate` getter (already exists)
- âœ… `events.template_data` column (already exists)
- âœ… EventService CRUD methods (already exists)

**Optional Enhancements:**
- Push notification filtering (backend)
- Audit trail for access (backend)
- Decoy event sync to native calendar (future)

---

## Timeline

**Week 7, Day 1 (February 7):**
- Create `SurprisePartyConfigSheet` (3-4 hours)
- Test template selection flow

**Week 7, Day 2 (February 8):**
- Create `SurprisePartyTaskList` (2-3 hours)
- Create `SurprisePartyDashboard` (3-4 hours)
- Test task management

**Week 7, Day 3 (February 9):**
- Implement privacy rendering in `EventCard` (2 hours)
- Implement role-based routing in `EventDetailScreen` (2 hours)
- Update calendar grid privacy filtering (1 hour)
- Full integration testing (2 hours)

**Total:** 15-18 hours

---

## Success Metrics

- [ ] Coordinators can create surprise party in <2 minutes
- [ ] Task completion saves within 500ms
- [ ] Target NEVER sees real event details
- [ ] Zero accidental leaks during beta testing
- [ ] 90%+ of testers understand decoy concept
- [ ] Progress tracking motivates coordinators to completion

---

## Notes

- **Database already implemented** - Focus purely on UI/UX
- **Privacy is UI + RLS** - Double layer of protection
- **Optimistic updates** - Instant UI feedback, rollback on error
- **Role-based rendering** - Single source of truth via provider
- **Warning indicators** - Prevent accidental spoilers
- **Follow existing patterns** - Use wizard, bottom sheets, providers like group proposal wizard
